<script>
  // --- Utilidades base (a√±o + contador + diagn√≥stico) ---
  document.getElementById('year') && (document.getElementById('year').textContent = new Date().getFullYear());
  (function(){try{const KEY='jp_visit_counter_inline';let n=parseInt(localStorage.getItem(KEY)||'0',10)||0;localStorage.setItem(KEY, String(++n));const el=document.getElementById('visitCounter');if(el) el.textContent=n.toLocaleString('es-AR');}catch(_){}})();
  (function(){const log=document.getElementById('diagLog');function ap(m,c){if(!log)return;const p=document.createElement('div');p.textContent=m;if(c)p.className=c;log.appendChild(p);}window.__diag={ok:(m)=>ap(m,'ok'),err:(m)=>ap(m,'err'),info:(m)=>ap(m)}})();

  // --- TU FOTO NUEVA (prioritaria y bloqueada en c2) ---
  const NEW_IMG_CANDIDATES = [
    "https://dl.dropboxusercontent.com/scl/fi/eti4id9palyp8bh1fb6wo/collage-1.jpg.JPG?rlkey=qp1jzx1y1hy62cn82ypn0snsy",
    "https://www.dropbox.com/scl/fi/eti4id9palyp8bh1fb6wo/collage-1.jpg.JPG?rlkey=qp1jzx1y1hy62cn82ypn0snsy&raw=1",
    "https://www.dropbox.com/scl/fi/eti4id9palyp8bh1fb6wo/collage-1.jpg.JPG?rlkey=qp1jzx1y1hy62cn82ypn0snsy&dl=1",
    "https://images.weserv.nl/?url=dl.dropboxusercontent.com/scl/fi/eti4id9palyp8bh1fb6wo/collage-1.jpg.JPG%3Frlkey%3Dqp1jzx1y1hy62cn82ypn0snsy&w=1200&h=800&fit=cover"
  ];
  const UNIQUE_FALLBACK = (i)=>`https://picsum.photos/seed/landia-unique-${i}/1200/800`;
  const cacheBust = (u)=>u+(u.includes('?')?'&':'?')+'v='+Date.now();

  function probe(url){return new Promise((res,rej)=>{const im=new Image();im.onload=()=>res(url);im.onerror=()=>rej(url);im.src=cacheBust(url);});}

  (async function run(){
    const used = new Set();
    const imgs = Array.from(document.querySelectorAll('.collage img.c-media-img'));
    if (imgs.length===0){ window.__diag?.err('No encontr√© im√°genes del collage'); return; }

    // 1) BLOQUEO c2 con tu imagen NUEVA (si existe)
    const c2 = document.querySelector('.collage .c2 img.c-media-img');
    if (c2){
      window.__diag?.info('Intento fijar TU foto NUEVA en c2‚Ä¶');
      let chosenC2 = null;
      for (const u of NEW_IMG_CANDIDATES){
        try { chosenC2 = await probe(u); break; } catch(_){ window.__diag?.err('ERROR c2 ‚Üí '+u); }
      }
      if (!chosenC2){ chosenC2 = UNIQUE_FALLBACK(2); window.__diag?.err('Fallback c2 ‚Üí '+chosenC2); }
      c2.src = chosenC2;
      c2.dataset._chosen = chosenC2;
      used.add(chosenC2);
      window.__diag?.ok('c2 fijada ‚Üí '+chosenC2);
    } else {
      window.__diag?.err('No hall√© c2; contin√∫o sin bloqueo.');
    }

    // 2) Cargar el RESTO evitando usar la de c2
    async function chooseFirstWorkingUnique(cands, fb, idx){
      // Nunca permitir que otra tarjeta use la de c2
      const c2src = c2?.dataset?._chosen || '';
      const filtered = cands.map(s=>s.trim()).filter(Boolean).filter(u=>u!==c2src);
      for (const url of filtered){
        if (used.has(url)) { window.__diag?.info('Salto duplicado ‚Üí '+url); continue; }
        try { const ok = await probe(url); used.add(ok); window.__diag?.ok('OK ‚Üí '+ok); return ok; }
        catch(_){ window.__diag?.err('ERROR ‚Üí '+url); }
      }
      // fallback √∫nico
      const fbPick = (fb && !used.has(fb) && fb!==c2src) ? fb : UNIQUE_FALLBACK(idx);
      used.add(fbPick); window.__diag?.err('Fallback √∫nico ‚Üí '+fbPick); return fbPick;
    }

    // Construye lista (c2 ya resuelta) y procesa las dem√°s primero
    const rest = imgs.filter(im=>im!==c2);
    await Promise.all(rest.map(async (img, idxAll)=>{
      const raw = img.getAttribute('data-candidates')||'';
      const fb  = img.getAttribute('data-fallback')||'';
      const cands = raw.split('|');
      const chosen = await chooseFirstWorkingUnique(cands, fb, idxAll);
      img.src = chosen; img.dataset._chosen = chosen;
    }));

    // 3) Verificaci√≥n final: si a√∫n hay repetidas, reemplazarlas (PRIORIDAD: NUEVA FOTO si no es c2)
    const seen = new Map();
    const ordered = imgs; // incluye c2 al inicio si estaba en DOM as√≠
    for (let i=0;i<ordered.length;i++){
      const img = ordered[i];
      const src = img.currentSrc || img.src;
      if (!seen.has(src)){ seen.set(src, i); continue; }

      // duplicado ‚Üí reemplazar
      window.__diag?.info(`Duplicado final: tarjeta ${i+1} repite a ${seen.get(src)+1} ‚Üí ${src}`);

      // si NO es c2, prob√° primero con tu foto NUEVA (si a√∫n no se us√≥ y no es la misma)
      const altList = [];
      const chosenC2 = c2?.dataset?._chosen || '';
      if (img!==c2){
        for (const u of NEW_IMG_CANDIDATES){
          if (!used.has(u) && u!==chosenC2) altList.push(u);
        }
      }
      // luego sus propios candidatos (excluyendo src actual y la de c2)
      const raw = img.getAttribute('data-candidates')||'';
      raw.split('|').forEach(u=>{
        u=u.trim(); if(!u) return;
        if (u!==src && u!==(chosenC2||'')) altList.push(u);
      });

      // elegir reemplazo
      let replaced = null;
      for (const u of altList){
        if (used.has(u)) continue;
        try { const ok = await probe(u); replaced = ok; break; } catch(_){ window.__diag?.err('ERROR repl ‚Üí '+u); }
      }
      if (!replaced){ replaced = UNIQUE_FALLBACK(i); }

      img.src = replaced; img.dataset._chosen = replaced; used.add(replaced);
      window.__diag?.ok(`Reemplazada tarjeta ${i+1} ‚Üí ${replaced}`);
    }

    // 4) Mensaje final
    window.__diag?.info('Hotfix v15.1 aplicado. c2 bloqueada con tu imagen nueva; duplicados evitados.');
  })();

  // --- Resto de features (moods, pausa, calma, consentimiento, voz) ---
  (function(){const btns=document.querySelectorAll('.moods button');btns.forEach(b=>b.addEventListener('click',()=>{const seed=b.dataset.seed||'calma';document.querySelectorAll('.c-media-img:not([data-candidates])').forEach((img,i)=>{img.src=`https://picsum.photos/seed/${seed}${i}/1200/800`;});}));})();
  (function(){const t=document.getElementById('timer');if(!t)return;const s=document.getElementById('startPausa');const r=document.getElementById('resetPausa');let v=60,h=null;function F(x){const m=Math.floor(x/60),ss=String(x%60).padStart(2,'0');return`0${m}:${ss}`}function tick(){v--;t.textContent=F(v);if(v<=0){clearInterval(h);h=null}}s&&s.addEventListener('click',()=>{if(h)return;v=60;t.textContent=F(v);h=setInterval(tick,1000)});r&&r.addEventListener('click',()=>{clearInterval(h);h=null;v=60;t.textContent=F(v)})})();
  document.getElementById('calmaToggle')?.addEventListener('change',e=>{document.documentElement.classList.toggle('calma-on', e.target.checked);});
  (function(){const modal=document.getElementById('modalCons');if(!modal)return;const open=[document.getElementById('cta-turno'),document.getElementById('cta-consulta')].filter(Boolean);const ok=document.getElementById('okCons');const cancel=document.getElementById('cancelCons');open.forEach(b=>b.addEventListener('click',()=>modal.classList.add('open')));ok&&ok.addEventListener('click',()=>{modal.classList.remove('open');location.href='mailto:likelandi@proton.me?subject=Solicitud%20de%20turno';});cancel&&cancel.addEventListener('click',()=>modal.classList.remove('open'));modal.addEventListener('click',e=>{if(e.target===modal)modal.classList.remove('open');});})();
  (function(){const btn=document.createElement('button');btn.textContent='üéôÔ∏è Voz';btn.className='cta';Object.assign(btn.style,{position:'fixed',left:'16px',bottom:'64px',zIndex:'60'});document.body.appendChild(btn);if('webkitSpeechRecognition'in window){const rec=new webkitSpeechRecognition();rec.lang='es-AR';rec.continuous=false;rec.onresult=e=>{const t=e.results[0][0].transcript.toLowerCase();if(t.includes('contacto'))location.hash='#contacto';if(t.includes('turno'))document.getElementById('cta-turno')?.click();if(t.includes('arriba'))scrollTo({top:0,behavior:'smooth'});if(t.includes('pausa'))location.hash='#pausa';};btn.onclick=()=>rec.start();}else{btn.style.display='none';}})();
</script>
